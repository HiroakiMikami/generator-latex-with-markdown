# Constants
mainTexName=main

# Directories
root=.
script=$(root)/scripts
## Sources
src=$(root)/src
doc=$(src)/doc
image=$(src)/image
graphviz=$(src)/graphviz
bib=$(src)/bib
## Generated
generated=$(root)/generated
generatedDoc=$(generated)/doc
generatedImage=$(generated)/image
generatedGraphviz=$(generated)/graphviz
generatedBib=$(generated)/bib

# Files
## Destination
destinationFile=$(root)/$(documentName).pdf
destinationDraftFile=$(root)/$(documentName)-draft.pdf
## Sources
mainTexFile=$(src)/$(mainTexName).tex
texFiles=$(shell find $(doc) -name "*.tex")
markdownFiles=$(shell find $(doc) -name "*.md")
pngFiles=$(shell find $(image) -name "*.png")
jpgFiles=$(shell find $(image) -name "*.jpg")
pdfFiles=$(shell find $(image) -name "*.pdf")
svgFiles=$(shell find $(image) -name "*.svg")
imageFiles=$(pngFiles) $(jpgFiles) $(pdfFiles)
dotFiles=$(shell find $(graphviz) -name "*.dot")
bibFiles=$(shell find $(bib) -name "*.bib")
## Generated
generatedMainTexFile=$(generated)/$(mainTexName).tex
generatedMainDraftTexFile=$(generated)/$(mainTexName)-draft.tex
generatedTexFiles=$(texFiles:$(doc)/%=$(generatedDoc)/%) $(markdownFiles:$(doc)/%.md=$(generatedDoc)/%.tex)
generatedImageFiles=$(imageFiles:$(image)/%=$(generatedImage)/%) $(svgFiles:$(image)/%.svg=$(generatedImage)/%.pdf)
generatedDotFiles=$(dotFiles:$(graphviz)/%.dot=$(generatedGraphviz)/%.pdf)
generatedBibFiles=$(bibFiles:$(bib)/%.bib=$(generatedBib)/%.bib)
### All generated files
generatedFiles=$(generatedTexFiles) $(generatedImageFiles) $(generatedDotFiles) $(generatedBibFiles)
### Generated by Tex
filesGeneratedByTex=$(generated)/$(mainTexName).log $(generated)/$(mainTexName).aux $(generated)/$(mainTexName).pdf $(generated)/$(mainTexName).bbl $(generated)/$(mainTexName).blg $(generated)/$(mainTexName)-draft.log $(generated)/$(mainTexName)-draft.aux $(generated)/$(mainTexName)-draft.pdf $(generated)/$(mainTexName)-draft.bbl $(generated)/$(mainTexName)-draft.blg
## Required by Tex
ifeq ($(latex),pdflatex)
else
ifeq ($(latex),pdftex)
else
	# xbb files are required when the LaTeX engine is neither pdflatex nor pdftex.
boundingBoxes=$(addsuffix .xbb, $(basename $(generatedImageFiles) $(generatedDotFiles)))
endif
endif

# Parameters and Settings
include parameters.mk
include commands.mk

.PHONY: all document draft assemble clean

all: document

document: $(destinationFile)
$(destinationFile): $(generated)/$(mainTexName).pdf
	if [ ! -n "`find $@ -maxdepth 0 -type l 2> /dev/null`" ]; then \
	  ln -s `realpath $< --relative-to=$(shell dirname $@)` $@; \
	fi
$(generated)/$(mainTexName).pdf: $(generatedMainTexFile) $(generatedFiles) $(boundingBoxes)
	# Generate aux file
	cd $(generated) && \
	$(latex) $(mainTexName) $(latexFlags)
	cd $(generated) && \
	$(bibtex) $(bibtexFlags) $(mainTexName) || echo
	# Generate PDF file
	cd $(generated) && \
	../$(script)/tex2pdf.sh $(latex) $(mainTexName) $(latexFlags)

draft: $(destinationDraftFile)
$(destinationDraftFile): $(generated)/$(mainTexName)-draft.pdf
	if [ ! -n "`find $@ -maxdepth 0 -type l 2> /dev/null`" ]; then \
	  ln -s `realpath $< --relative-to=$(shell dirname $@)` $@; \
	fi
$(generated)/$(mainTexName)-draft.pdf: $(generatedMainDraftTexFile) $(generatedFiles) $(boundingBoxes)
	# Generate aux file
	cd $(generated) && \
	$(latex) $(mainTexName)-draft $(latexFlags)
	cd $(generated) && \
	$(bibtex) $(bibtexFlags) $(mainTexName)-draft || echo
	# Generate PDF file
	cd $(generated) && \
	../$(script)/tex2pdf.sh $(latex) $(mainTexName)-draft $(latexFlags)

$(generatedMainDraftTexFile): $(mainTexFile)
	sed -e 's|\documentclass{|\documentclass[draft]{|g' \
			-e 's|\documentclass\[|\documentclass[draft, |g' \
			$(mainTexFile) > $(generatedMainDraftTexFile)

assemble: $(generated)/$(mainTexName)-assmeble.tex
$(generated)/$(mainTexName)-assmeble.tex: $(generatedMainTexFile) $(generatedTexFiles)
	node $(script)/assemble.js $(generated) $(generatedMainTexFile) > $(generated)/$(mainTexName)-assmeble.tex

clean:
	rm -f $(generatedFiles) $(boundingBoxes)
	rm -f $(filesGeneratedByTex)
	rm -f $(destinationFile) $(destinationDraftFile)

# Make rules
include makefile.d/markdown.mk
include makefile.d/svg.mk
include makefile.d/graphviz.mk
include makefile.d/symlink.mk

%.xbb: %.pdf
		$(bb) $<
%.xbb: %.jpg
		$(bb) $<
%.xbb: %.png
		$(bb) $<
%.xbb: %.jpg
		$(bb) $<
