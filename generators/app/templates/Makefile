# Constants
mainTexName=main

# Directories
root=.
scriptDir=$(root)/scripts
## Sources
src=$(root)/src
doc=$(src)/doc
image=$(src)/image
## Generated
generated=$(root)/generated
generatedDoc=$(generated)/doc
generatedImage=$(generated)/image

# Files
## Destination
destinationFile=$(root)/$(documentName).pdf
## Sources
mainTexFile=$(src)/$(mainTexName).tex
texFiles=$(shell find $(doc) -name "*.tex")
markdownFiles=$(shell find $(doc) -name "*.md")
pngFiles=$(shell find $(image) -name "*.png")
jpgFiles=$(shell find $(image) -name "*.jpg")
pdfFiles=$(shell find $(image) -name "*.pdf")
svgFiles=$(shell find $(image) -name "*.svg")
imageFiles=$(pngFiles) $(jpgFiles) $(pdfFiles)
## Generated
generatedMainTexFile=$(generated)/$(mainTexName).tex
generatedTexFiles=$(texFiles:$(doc)/%=$(generatedDoc)/%) $(markdownFiles:$(doc)/%.md=$(generatedDoc)/%.tex)
generatedImageFiles=$(imageFiles:$(image)/%=$(generatedImage)/%) $(svgFiles:$(image)/%.svg=$(generatedImage)/%.pdf)
### All generated files
generatedFiles=$(generatedMainTexFile) $(generatedTexFiles) $(generatedImageFiles)
### Generated by Tex
filesGeneratedByTex=$(generated)/$(mainTexName).log $(generated)/$(mainTexName).aux $(generated)/$(mainTexName).pdf
## Required by Tex
ifeq ($(latex),pdflatex)
else
ifeq ($(latex),pdftex)
else
	# xbb files are required when the LaTeX engine is neither pdflatex nor pdftex.
boundingBoxes=$(addsuffix .xbb, $(basename $(generatedImageFiles)))
endif
endif

# Parameters and Settings
include parameters.mk
include commands.mk

.PHONY: all document clean

all: document

document: $(destinationFile)
$(destinationFile): $(generated)/$(mainTexName).pdf
	if [ ! -n "`find $@ -maxdepth 0 -type l 2> /dev/null`" ]; then \
		ln -s $(generated)/$(mainTexName).pdf $(destinationFile); \
	fi
$(generated)/$(mainTexName).pdf: $(generatedFiles) $(boundingBoxes)
	# Generate aux file
	cd $(generated) && \
	$(latex) $(mainTexName) $(latexFlags)
	# Generate PDF file
	cd $(generated) && \
	../$(scriptDir)/tex2pdf.sh $(latex) $(mainTexName) $(latexFlags)

clean:
	rm -f $(generatedFiles) $(boundingBoxes)
	rm -f $(filesGeneratedByTex)
	rm -f $(destinationFile)

# Make rules
include makefile.d/markdown.mk
include makefile.d/svg.mk
include makefile.d/symlink.mk

%.xbb: %.pdf
		$(bb) $<
%.xbb: %.jpg
		$(bb) $<
%.xbb: %.png
		$(bb) $<
%.xbb: %.jpg
		$(bb) $<
