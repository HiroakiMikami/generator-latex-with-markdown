# Constants
mainTexName=main

# Directories
root=.
scriptDir=$(root)/scripts
## Sources
src=$(root)/src
doc=$(src)/doc
## Generated
generated=$(root)/generated
generatedDoc=$(generated)/doc

# Files
## Destination
destinationFile=$(root)/$(documentName).pdf
## Sources
mainTexFile=$(src)/$(mainTexName).tex
texFiles=$(shell find $(doc) -name "*.tex")
markdownFiles=$(shell find $(doc) -name "*.md")
## Generated
generatedMainTexFile=$(generated)/$(mainTexName).tex
generatedTexFiles=$(texFiles:$(doc)/%=$(generatedDoc)/%) $(markdownFiles:$(doc)/%.md=$(generatedDoc)/%.tex)
### All generated files
generatedFiles=$(generatedMainTexFile) $(generatedTexFiles)
## Generated by Tex
filesGeneratedByTex=$(generated)/$(mainTexName).log $(generated)/$(mainTexName).aux $(generated)/$(mainTexName).pdf

# Parameters and Settings
include parameters.mk
include commands.mk

.PHONY: all document clean

all: document

document: $(destinationFile)
$(destinationFile): $(generated)/$(mainTexName).pdf
	if [ ! -n "`find $@ -maxdepth 0 -type l 2> /dev/null`" ]; then \
		ln -s $(generated)/$(mainTexName).pdf $(destinationFile); \
	fi
$(generated)/$(mainTexName).pdf: $(generatedFiles)
	# Generate aux file
	cd $(generated) && \
	$(latex) $(mainTexName) $(latexFlags)
	# Generate PDF file
	cd $(generated) && \
	../$(scriptDir)/tex2pdf.sh $(latex) $(mainTexName) $(latexFlags)

clean:
	rm -f $(generatedFiles)
	rm -f $(filesGeneratedByTex)
	rm -f $(destinationFile)

# Make rules
include makefile.d/markdown.mk
include makefile.d/symlink.mk
